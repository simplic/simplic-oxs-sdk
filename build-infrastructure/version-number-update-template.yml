parameters:
  connection_string: ""
  git_user: ""
  git_pass: ""
  branch_name: ""

steps:
  - task: CmdLine@2
    inputs:
      script: |
        git checkout ${{parameters.branch_name}}
    displayName: Checkout ${{parameters.branch_name}}
  - task: CmdLine@2
    inputs:
      script: |
        git config --system core.longpaths true
        git config --global user.email "git@simplic.biz"
        git config --global user.name "simplic-bot"
        git clone https://${{parameters.git_user}}:${{parameters.git_pass}}@github.com/simplic/build-infrastructure -b master
        rd /s /q ".\build-infrastructure\.git\"
        cd build-infrastructure
        pip install -r requirements.txt
        cd db_drivers
        regsvr32 /s dbodbc12simplic_azure.dll
    displayName: Installing prequisites
  - task: CmdLine@2
    inputs:
      script: |
        python build-infrastructure/update_version_number.py --git-user ${{parameters.git_user}} --git-pass ${{parameters.git_pass}} -c ${{parameters.connection_string}}
    displayName: Updating version number
  - powershell: |
      Write-Host "Cancel all jobs..."
      $url = "$($env:SYSTEM_TEAMFOUNDATIONCOLLECTIONURI)$env:SYSTEM_TEAMPROJECTID/_apis/build/builds/$($env:BUILD_BUILDID)?api-version=2.0"
        $header = @{ Authorization = "Bearer $env:SYSTEM_ACCESSTOKEN"  }
        $body = @{ 'status'='Cancelling' } | ConvertTo-Json
        Invoke-RestMethod -Uri $url -Method Patch -Body $body -Headers $header -ContentType application/json
    displayName: Cancel if updating versions fails
    condition: failed()
    env:
        System_AccessToken: $(System.AccessToken)