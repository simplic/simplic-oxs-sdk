parameters:
  connection_string: ""
  git_user: ""
  git_token: ""
  branch_name: ""

steps:
  - task: CmdLine@2
    displayName: Checkout to ${{parameters.branch_name}}
    inputs:
      script: | 
        git fetch 
        echo Fetching
        git checkout --track origin/${{parameters.branch_name}}
        git pull origin ${{parameters.branch_name}}
        
  - task: CmdLine@2
    condition: and(succeeded(), eq(variables['Agent.OS'], 'Windows_NT'))
    inputs:
      script: |
        git config --global credential.interactive false
        git config --system core.longpaths true
        git config --global user.email "git@simplic.biz"
        git config --global user.name "simplic-bot"
        git clone https://${{parameters.git_user}}:${{parameters.git_token}}@github.com/simplic/build-infrastructure -b master
        rd /s /q ".\build-infrastructure\.git\"
        cd build-infrastructure
        pip install -r requirements.txt
        cd db_drivers
        regsvr32 /s dbodbc12simplic_azure.dll
    displayName: Installing prequisites (Windows)

  - task: CmdLine@2
    condition: and(succeeded(), eq(variables['Agent.OS'], 'Linux'))
    inputs:
      script: |
        rm -f ~/.gitconfig.lock
        git config --global credential.interactive false
        git config --system core.longpaths true
        git config --global user.email "git@simplic.biz"
        git config --global user.name "simplic-bot"
        git config --global credential.helper store
        git clone https://${{parameters.git_user}}:${{parameters.git_token}}@github.com/simplic/build-infrastructure -b master
        cd build-infrastructure
        rm -rf .git
        pip install -r requirements.txt
    displayName: Installing prequisites (Linux)
         
  - task: PythonScript@0
    inputs:
      scriptSource: 'filePath'
      scriptPath: 'build-infrastructure/update_version_number.py'
      arguments: '--git-user ${{parameters.git_user}} --git-token ${{parameters.git_token}} -c ${{parameters.connection_string}}'
    displayName: Updating version number
    
  - powershell: |
      Write-Host "Cancel all jobs..."
      $url = "$($env:SYSTEM_TEAMFOUNDATIONCOLLECTIONURI)$env:SYSTEM_TEAMPROJECTID/_apis/build/builds/$($env:BUILD_BUILDID)?api-version=2.0"
        $header = @{ Authorization = "Bearer $env:SYSTEM_ACCESSTOKEN"  }
        $body = @{ 'status'='Cancelling' } | ConvertTo-Json
        Invoke-RestMethod -Uri $url -Method Patch -Body $body -Headers $header -ContentType application/json
    displayName: Cancel if updating versions fails
    condition: failed()
    env:
        System_AccessToken: $(System.AccessToken)
